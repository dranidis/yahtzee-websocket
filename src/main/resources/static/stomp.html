<!doctype html>
<html>

<head>
    <title>Yahtzee!</title>
    <link href="css/custom.css" rel="stylesheet">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
    <script src="/webjars/sockjs-client/sockjs.min.js"></script>
    <script src="/webjars/stomp-websocket/stomp.min.js"></script>

    <script src="js/custom.js"></script>

    <script>
        $(document).ready(function () {
            $("#gameControl").hide();

            var playerName;

            function setConnected(connected) {
                if (connected) {
                    $("#connected").html("Connected!");
                }
                else {
                    $("#connected").html("Not Connected!");
                }
                // $("#greetings").html("");
            }

            function connect() {
                var socket = new SockJS('/gamews');
                stompClient = Stomp.over(socket);
                stompClient.connect({}, function (frame) {
                    console.log('Connected: ' + frame);
                    stompClient.subscribe('/topic/players', function (player) {
                        console.log("received from /topic/players:" + player.body)
                        showPlayer(JSON.parse(player.body).name);
                    });
                    stompClient.subscribe('/topic/game', function (game) {
                        console.log("received from /topic/game:" + game.body)
                        handleGame(JSON.parse(game.body));
                    });
                    setConnected(true);
                });
            }
            connect();
            // TODO: After connecting get players already in the game

            function showPlayer(name) {
                $("#players").append("<div>" + name + "</div>");
            }

            function handleGame(game) {
                $("#startBtn").prop("disabled", true);
                if (game.currentPlayer == playerName) {
                    $("#gameControl").show();
                } else {
                    $("#gameControl").hide();

                }
                $('#dice').html(
                    game.dice[0] + " " +
                    game.dice[1] + " " +
                    game.dice[2] + " " +
                    game.dice[3] + " " +
                    game.dice[4] + " "
                );
            }

            $("#addPlayerBtn").click(function () {
                var name = $("#playerName").val();
                // remember the player's name
                playerName = name;

                if (name != "") {
                    stompClient.send("/app/player", {}, JSON.stringify({ 'name': name }));
                    $("#addPlayerBtn").prop("disabled", true);
                }
            });

            $("#startBtn").click(function () {
                stompClient.send("/app/start", {});
            });


            function succesFun(result) {
                $("#div1").html(result);
            }

            $("#keepBtn").click(function () {
                var keepArray = [];
                for (i = 1; i < 6; i++) {
                    if ($("#keep" + i).is(':checked')) {
                        keepArray.push(i);
                    }
                    // var keepValue = keepArray.join();
                }
                stompClient.send("/app/roll", {}, JSON.stringify({ 'name': playerName, 'keep': keepArray }));

            });


            // var scoreCat = "";
            // $("#scoreBtn").click(function() {
            //     scoreCat = $("#catName").val();
            //     $.ajax({
            //         url: "score?name=" + playerName + "&cat=" + scoreCat,
            //         success: function(result) {
            //             $("#div1").html(JSON.stringify(result));
            //         }
            //     });
            // });

            $(".catscore").click(function () {
                console.log(this.id);
                var tid = this.id
                $.ajax({
                    url: "score?name=" + playerName + "&cat=" + this.id,
                    dataType: "json",
                    success: function (result) {
                        // var data = JSON.parse(result);
                        var score = result.score;
                        console.log("#" + tid);
                        $("#" + tid).html(score);
                    }
                });
            });



        });
    </script>
</head>

<body>
    <div id="connected"></div>
    <div>PLAYERS
        <div id="players"></div>
    </div>
    <p th:text="'H</div>e</div>llo, ' + ${name} + '!'">Yahtzee game! </p>

    <!-- <p>
        <button id="gameBtn">New Game</button>
    </p> -->
    <p>
        <input id="playerName" type="text" value="" />
        <button id="addPlayerBtn">Add Player</button>
    </p>
    <p>
        <button id="startBtn">Start</button>
    </p>
    <div>Dice rolled:
        <div id="dice"></div>
    </div>
    <div id="gameControl">
        <div id="dice"></div>
        <p>
            Choose dice to keep:
            <input type="checkbox" id="keep1">
            <input type="checkbox" id="keep2">
            <input type="checkbox" id="keep3">
            <input type="checkbox" id="keep4">
            <input type="checkbox" id="keep5">
            <button id="keepBtn">Roll</button>

        </p>

        <p>
            Category to score:
            <input id="catName" type="text" value="" />
            <button id="scoreBtn">Score</button>
        </p>


        <table>
            <tr>
                <td class="catlabel"> 1's</td>
                <td class="catscore" id="1s">_____</td>
                <td class="catlabel"> 3 of a kind</td>
                <td class="catscore" id="3k">_____</td>
            </tr>
            <tr>
                <td class="catlabel"> 2's</td>
                <td class="catscore" id="2s">_____</td>
                <td class="catlabel"> 4 of a kind</td>
                <td class="catscore" id="4k">_____</td>
            </tr>
            <tr>
                <td class="catlabel"> 3's</td>
                <td class="catscore" id="3s">_____</td>
                <td class="catlabel"> full house</td>
                <td class="catscore" id="fh">_____</td>
            </tr>
            <tr>
                <td class="catlabel"> 4's</td>
                <td class="catscore" id="4s">_____</td>
                <td class="catlabel"> Sm. Straight</td>
                <td class="catscore" id="s4">_____</td>
            </tr>
            <tr>
                <td class="catlabel"> 5's</td>
                <td class="catscore" id="5s">_____</td>
                <td class="catlabel"> Lg. Straight</td>
                <td class="catscore" id="s5">_____</td>
            </tr>
            <tr>
                <td class="catlabel"> 6's</td>
                <td class="catscore" id="6s">_____</td>
                <td class="catlabel"> Yahtzee</td>
                <td class="catscore" id="5k">_____</td>
            </tr>
            <tr>
                <td class="catlabel"> Bonus</td>
                <td id="UB">_____</td>
                <td class="catlabel"> Chance</td>
                <td class="catscore" id="ch">_____</td>
            </tr>
            <tr>
                <td class="catlabel"> Section Total</td>
                <td id="ST">_____</td>
                <td class="catlabel"> Yahtzee Bonus</td>
                <td id="YB">_____</td>
            </tr>
            <tr>
                <td></td>
                <td></td>
                <td class="catlabel"> Total</td>
                <td id="TOT">_____</td>
            </tr>
        </table>
    </div>

    <div id="div1">
        <h2></h2>
    </div>
</body>

</html>